<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Or√ßamento Sienge ‚Äì Vers√£o Web</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 25px; }
        h1 { color: #2c3e50; margin-bottom: 5px; }
        .subtitle { color: #7f8c8d; margin-bottom: 25px; }
        .etapa { margin-bottom: 30px; border: 1px solid #dcdcdc; border-radius: 8px; overflow: hidden; }
        .etapa-header { background: #34495e; color: white; padding: 15px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .etapa-header:hover { background: #2c3e50; }
        .etapa-content { display: none; padding: 15px; background: #fafafa; }
        .etapa.ativo .etapa-content { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #ecf0f1; color: #2c3e50; padding: 10px; text-align: left; }
        td, th { border: 1px solid #bdc3c7; padding: 8px; }
        input[type=number] { width: 80px; padding: 5px; border: 1px solid #bdc3c7; border-radius: 4px; }
        .totals { background: #ecf0f1; padding: 20px; border-radius: 8px; margin-top: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 15px; }
        .total-card { background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .total-card h3 { margin-bottom: 5px; color: #34495e; }
        .total-card .valor { font-size: 1.4em; font-weight: bold; color: #27ae60; }
        .loading { text-align: center; padding: 50px; font-size: 1.2em; color: #7f8c8d; }
        .error { color: #e74c3c; text-align: center; padding: 20px; }
        footer { margin-top: 30px; text-align: center; color: #95a5a6; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèóÔ∏è Or√ßamento Sienge ‚Äì Base SINAPI</h1>
        <div class="subtitle">Edite as quantidades e veja os totais atualizados automaticamente</div>

        <div id="loading" class="loading">Carregando dados...</div>
        <div id="app" style="display: none;"></div>
        <div id="error" class="error" style="display: none;"></div>

        <footer>Dados extra√≠dos da planilha Sienge 5.0 (base dez/2024)</footer>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let dados = null;
        let etapas = [];
        let composicoesMap = new Map();
        let parametros = null;

        // Elementos
        const loadingEl = document.getElementById('loading');
        const appEl = document.getElementById('app');
        const errorEl = document.getElementById('error');

        // Carregar JSON (embutido no pr√≥prio arquivo, mas aqui vamos carregar externamente)
        fetch('dados.json')
            .then(response => {
                if (!response.ok) throw new Error('N√£o foi poss√≠vel carregar dados.json');
                return response.json();
            })
            .then(data => {
                dados = data;
                composicoesMap = new Map(dados.composicoes.map(c => [c.codigo, c]));
                parametros = dados.parametros;
                processarEtapas();
                renderizar();
                loadingEl.style.display = 'none';
                appEl.style.display = 'block';
            })
            .catch(err => {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.innerHTML = `‚ùå Erro: ${err.message}<br>Verifique se o arquivo dados.json est√° na mesma pasta.`;
            });

        // Associa os custos das composi√ß√µes aos itens
        function processarEtapas() {
            etapas = dados.etapas.map(etapa => {
                const itensComCusto = etapa.itens.map(item => {
                    const comp = composicoesMap.get(item.codigo) || { custo_material: 0, custo_mao_obra: 0 };
                    return {
                        ...item,
                        custo_material_unit: comp.custo_material,
                        custo_mao_obra_unit: comp.custo_mao_obra,
                        custo_total_unit: comp.custo_material + comp.custo_mao_obra
                    };
                });
                return { ...etapa, itens: itensComCusto };
            });
        }

        // Renderiza toda a interface
        function renderizar() {
            let html = '';
            etapas.forEach((etapa, idx) => {
                html += `
                    <div class="etapa" id="etapa-${idx}">
                        <div class="etapa-header" onclick="toggleEtapa(${idx})">
                            <span>üìÅ ${etapa.nome}</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="etapa-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Unid.</th>
                                        <th>Quantidade</th>
                                        <th>Material (R$)</th>
                                        <th>M√£o de Obra (R$)</th>
                                        <th>Total (R$)</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                etapa.itens.forEach((item, i) => {
                    html += `
                        <tr>
                            <td>${item.codigo}</td>
                            <td>${item.descricao}</td>
                            <td>${item.unidade}</td>
                            <td><input type="number" value="${item.quantidade}" step="0.01" min="0" data-etapa="${idx}" data-item="${i}" onchange="atualizarQuantidade(this)"></td>
                            <td class="mat-${idx}-${i}">${(item.custo_material_unit * item.quantidade).toFixed(2)}</td>
                            <td class="mo-${idx}-${i}">${(item.custo_mao_obra_unit * item.quantidade).toFixed(2)}</td>
                            <td class="tot-${idx}-${i}">${(item.custo_total_unit * item.quantidade).toFixed(2)}</td>
                        </tr>
                    `;
                });
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            // Painel de totais
            html += `
                <div class="totals" id="totals-panel">
                    <div class="total-card">
                        <h3>üí∞ Total de Materiais</h3>
                        <div class="valor" id="total-material">0,00</div>
                    </div>
                    <div class="total-card">
                        <h3>üë∑ Total de M√£o de Obra</h3>
                        <div class="valor" id="total-mo">0,00</div>
                    </div>
                    <div class="total-card">
                        <h3>üìä Total sem BDI</h3>
                        <div class="valor" id="total-sem-bdi">0,00</div>
                    </div>
                    <div class="total-card">
                        <h3>üìà BDI</h3>
                        <div class="valor" id="valor-bdi">0,00</div>
                    </div>
                    <div class="total-card">
                        <h3>‚öñÔ∏è Encargos Sociais (LS)</h3>
                        <div class="valor" id="valor-encargos">0,00</div>
                    </div>
                    <div class="total-card">
                        <h3>üèÅ Total Geral</h3>
                        <div class="valor" id="total-geral">0,00</div>
                    </div>
                </div>
            `;

            appEl.innerHTML = html;

            // Abre a primeira etapa por padr√£o
            if (etapas.length > 0) toggleEtapa(0);
            calcularTotais();
        }

        // Abre/fecha etapa
        window.toggleEtapa = function(idx) {
            const etapaDiv = document.getElementById(`etapa-${idx}`);
            etapaDiv.classList.toggle('ativo');
        };

        // Atualiza quantidade e recalcula
        window.atualizarQuantidade = function(input) {
            const etapaIdx = input.dataset.etapa;
            const itemIdx = input.dataset.item;
            const novaQtd = parseFloat(input.value) || 0;
            etapas[etapaIdx].itens[itemIdx].quantidade = novaQtd;

            // Atualiza c√©lulas da linha
            const item = etapas[etapaIdx].itens[itemIdx];
            const matCell = document.querySelector(`.mat-${etapaIdx}-${itemIdx}`);
            const moCell = document.querySelector(`.mo-${etapaIdx}-${itemIdx}`);
            const totCell = document.querySelector(`.tot-${etapaIdx}-${itemIdx}`);
            if (matCell) matCell.innerText = (item.custo_material_unit * novaQtd).toFixed(2);
            if (moCell) moCell.innerText = (item.custo_mao_obra_unit * novaQtd).toFixed(2);
            if (totCell) totCell.innerText = (item.custo_total_unit * novaQtd).toFixed(2);

            calcularTotais();
        };

        // Calcula totais gerais
        function calcularTotais() {
            let totalMaterial = 0, totalMO = 0;
            etapas.forEach(etapa => {
                etapa.itens.forEach(item => {
                    totalMaterial += item.custo_material_unit * item.quantidade;
                    totalMO += item.custo_mao_obra_unit * item.quantidade;
                });
            });
            const totalSemBDI = totalMaterial + totalMO;
            const p = parametros;

            // F√≥rmula do BDI (exatamente como na planilha)
            const bdiFactor = ((1 + p.adm_central) * (1 + p.despesas_fin) * (1 + p.garantia) * (1 + p.lucro) /
                              (1 - (p.pis + p.cofins + p.iss))) - 1;
            const bdiValor = totalSemBDI * bdiFactor;
            const encargos = totalMO * p.encargos_sociais;
            const totalFinal = totalSemBDI + encargos + bdiValor;

            document.getElementById('total-material').innerText = totalMaterial.toFixed(2);
            document.getElementById('total-mo').innerText = totalMO.toFixed(2);
            document.getElementById('total-sem-bdi').innerText = totalSemBDI.toFixed(2);
            document.getElementById('valor-bdi').innerText = bdiValor.toFixed(2);
            document.getElementById('valor-encargos').innerText = encargos.toFixed(2);
            document.getElementById('total-geral').innerText = totalFinal.toFixed(2);
        }
    </script>
</body>
</html>
